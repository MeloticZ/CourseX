## CODEMAP: CourseX Code Reference

This document explains what each file does and describes every exported function (and important internal helpers) with their inputs and outputs.

### Project overview
- **Stack**: Nuxt 4 + Vue 3 + TypeScript + Tailwind (via `@tailwindcss/vite`).
- **Architecture**: 3-panel layout (`LeftPanel`, `MiddlePanel`, `RightPanel`) under the route `course/[...slug]`.
- **Data**: Local JSON under `app/assets/data/` generated by `scripts/generate-test-data.py`.
- **State**: Lightweight store implemented via Nuxt `useState` in `useStore.ts` (with localStorage persistence helper).

---

### Directory structure (functional summary)
- `app/app.vue`: Root shell; renders `NuxtPage` in a styled container.
- `app/pages/index.vue`: Redirects to `/course/all`.
- `app/pages/course/[...slug].vue`: Main page with 3 panels; syncs URL slug to selected course/section.
- `app/components/`: UI components for panels, course cards, filters, and program tree.
- `app/composables/`: Data access, state, scheduling, filtering, and utility composables.
- `app/assets/css/main.css`: Design tokens and utility styles.
- `app/assets/data/`: `programs.json` and `courses.json` used as the app’s data source.
- `scripts/generate-test-data.py`: Pulls USC classes data and generates the JSON assets.
- `nuxt.config.ts`: Nuxt config, modules, CSS, Vite plugin for Tailwind, head meta.
- `eslint.config.mjs`, `tsconfig.json`, `package.json`: Tooling/config.

---

### Pages
#### `app/app.vue`
- Purpose: Global layout wrapper with background and a centered container for pages.

#### `app/pages/index.vue`
- Purpose: Redirect to `/course/all` on both server and client.
- Behavior: Uses `navigateTo` server-side and `router.replace` client-side.

#### `app/pages/course/[...slug].vue`
- Purpose: The main route rendering `LeftPanel`, `MiddlePanel`, and `RightPanel`.
- Functions:
  - `parseSlug(): { mode: 'unknown' } | { mode: 'all'|'scheduled', courseCode: string|null, sectionId: string|null } | { mode: 'program', school: string, program: string, courseCode: string|null, sectionId: string|null }`
    - Input: Reads `route.params.slug` (string[]).
    - Output: Structured mode object.
  - Watcher on `route.fullPath`: Applies selection via `useCourseSelection()` based on parsed slug; clears selection if unknown.

---

### Components
#### `app/components/LeftPanel.vue`
- Purpose: Header, search for schools/programs, settings (theme, term), and a scrollable `ProgramTree` with persisted scroll.
- Key state/refs: `query`, `leftScrollRef`, `settingsOpen`, `settingsRef`.
- Computed: `commitSha`, `themeIcon`, `preferenceLabel`, `totalScheduledUnits`, `totalScheduledUnitsLabel` (via `useStore`).
- Functions:
  - `onLeftScroll()`: Persist current scrollTop to a Nuxt state key.
  - `restoreLeftScroll()`: Restore scrollTop after mount/route changes.
  - `cycleTheme()`: Cycle color mode among `system → dark → light`.
  - `toggleSettings()`, `onDocumentClick(e)`, `onDocumentKeydown(e)`: Settings menu open/close management.
  - Lifecycle: mounts data via `listSchoolAndPrograms()`, attaches/detaches listeners, restores scroll on activation/navigation.

#### `app/components/MiddlePanel.vue`
- Purpose: Course list with filters and variable-height virtualization.
- Uses: `useCourseListSource`, `useCourseFilters`, `useVariableVirtualList`, `useScrollMemory`, `useCourseSelection`.
- Events to `FilterBar`: tri-state toggles, conflicts toggle, enrollment toggle, reset.
- Functions:
  - `cycleTriState(key)`, `setTriState(key, v)`: Manage tri-state filters.
  - `toggleConflicts()`, `setConflictsAny()`: Conflict filter controls.
  - `toggleEnrollmentOpenOnly()`, `setEnrollmentAny()`: Enrollment filter controls.
  - Virtualization API wiring: `onRowRef`, `scheduleUpdateViewport`, etc.
  - `onSectionClick(courseCode, sectionId)`: Update selection and navigate appropriately based on route mode.

#### `app/components/RightPanel.vue`
- Purpose: Course details viewer and interactive weekly schedule grid.
- Uses: `getCourseDetails`, `getSectionDetails`, `useSchedule`, `useCourseTypeMeta`, `useStore`, `useCourseListSource`, `useCourseSelection`.
- Computed: `instructors` (CSV or TBA), `typeMeta` (badge/icon styling).
- Scheduling constants: `DAY_LABELS`, `START_MINUTES`, `END_MINUTES`, `SLOT_MINUTES` via `useSchedule` export.
- Functions:
  - `loadDetails()`: Fetch details for selected course/section; prefers section-specific details when available.
  - `blocksByDay(dayIndex)`, `previewBlocksByDay(dayIndex)`: Filter schedule blocks for display per day.
  - `styleForBlock(block)`, `styleForPreviewBlock(block)`: Map blocks to inline style objects.
  - Drag-create manual blocks: `eventMinutesInColumn(e, el)`, `onDayMouseDown(e, dayIndex)`, `onWindowMouseMove`, `onWindowMouseUp`.
  - Navigation on block click: `onBlockClick(id)` pushes route to course/section that owns the block.
  - Selection/schedule: `isInSchedule` (computed), `onAddOrRemove()`, hover preview `onHoverPreviewEnter/Leave()`.

#### `app/components/ProgramTree.vue`
- Purpose: Searchable list of schools and programs; persists which schools are expanded.
- Props: `{ schools: { name, prefix, programs[] }[], query?: string }`.
- State: `openSchoolKeySet` (global across routes), initialized with all schools open.
- Functions:
  - `filteredSchools`: Computed list of schools with programs filtered by query.
  - `isOpen(school)`, `toggleSchool(school)`: Expand/collapse per school.

#### `app/components/CourseCard.vue`
- Purpose: Displays a single course with its sections and key badges.
- Props: `{ title: string, code: string, description: string, sections: UICourseSection[] }`.
- Emits: `section-click(sectionId: string)`.
- Functions:
  - `occupancyClassFor(section, type)`: CSS class for capacity status.
  - `scheduleCollisionClassFor(section, type)`: CSS class when section collides with scheduled blocks (via `useStore.checkScheduleCollision`).
  - `sectionClassFor(section)`: Row background when full or colliding.
  - `sectionUnitsToRender(section)`: Display string for units.
  - `sectionMeta(section)`, `sectionTypeMetaClass(section)`, `sectionTypeLabel(section)`: Type/Zebra badge/label from `useCourseTypeMeta`.
  - `onSectionHoverEnter(section)`, `onSectionHoverLeave()`: Show/clear preview blocks in the schedule.

#### `app/components/FilterBar.vue`
- Purpose: Compact control surface for day/time, units, level, tri-state flags, conflicts, and enrollment filters.
- Props: `{ show: boolean, filters: CourseFiltersState }`.
- Emits: `cycle-tri`, `set-tri`, `toggle-conflicts`, `set-conflicts-any`, `toggle-enrollment-open-only`, `set-enrollment-any`, `reset`.
- Functions:
  - Day selection: `isDaySelected(idx)`, `toggleDay(idx)`, `clearDays()`, `dayActiveClass(idx)`.
  - Time inputs: `timeStart`/`timeEnd` via `useDraftInput` bound to `filters.timeStartMinutes|timeEndMinutes`; `clearStartTime()`, `clearEndTime()`.
  - Units inputs: `unitsMin`/`unitsMax` via `useDraftInput`; `clearUnitsMin()`, `clearUnitsMax()`.
  - Course level input: `courseLevel` via `useDraftInput` sets `filters.courseLevelMin/Max`; `clearCourseLevel()`.
  - Visual state computeds: `dClearanceClass`, `prereqClass`, `conflictsClass`, `conflictsIconClass`, `enrollmentClass`, `enrollmentIconClass`.

---

### Composables and utilities
#### `app/composables/useAPI.ts`
- Types:
  - `UICourseSection`: Section view model.
  - `UICourse`: Course view model with sections.
  - Internal raw types `RawSection`, `RawGroupedCourse` for asset parsing.
- Functions:
  - `listSchoolAndPrograms(): Promise<any>`
    - Input: none
    - Output: Programs JSON object from `assets/data/programs.json`.
  - `listAllCourses(): Promise<UICourse[]>`
    - Input: none
    - Output: Unique list of `UICourse` across all schools/programs by `(code::title)` merging sections.
  - `getCourseDetails(courseCode: string): Promise<CourseDetails | null>`
    - Input: `courseCode` (string)
    - Output: Aggregated details across sections; or `null` if not found/error.
  - `getSectionDetails(courseCode: string, sectionId: string): Promise<CourseDetails | null>`
    - Input: `courseCode`, `sectionId`
    - Output: Details for a specific section; or `null` if not found/error.
  - `getSchoolCourses(schoolPrefix: string, programPrefix: string): Promise<UICourse[]>`
    - Input: `schoolPrefix`, `programPrefix`
    - Output: Courses for a specific program; merges duplicate sections.
  - Internal mappers:
    - `mapSection(raw: RawSection): UICourseSection | null`
    - `mapGroupedToUICourse(raw: RawGroupedCourse): UICourse | null`

#### `app/composables/useCourseFilters.ts`
- Types: `TriState`, `EnrollmentFilter`, `CourseFiltersState`.
- Internal helpers (inputs → outputs):
  - `parseUnitsToNumber(units) → number`
  - `normalizeString(value) → string`
  - `extractCourseLevel(code) → number | null`
  - `normalizeSectionType(raw) → string`
  - `sectionConflictsWithSchedule(section, hasCollisionFn) → boolean`
  - `sectionMatchesScheduleFilters(section, days[], startMin|null, endMin|null) → boolean`
  - `sectionMatchesTriState(flag, state) → boolean`
  - `sectionMatchesEnrollment(section, mode) → boolean`
  - `sectionMatchesUnits(section, min|null, max|null) → boolean`
  - `courseMatchesLevel(course, min|null, max|null) → boolean`
  - `courseMatchesSearch(course, search) → boolean`
  - `sectionMatchesTypes(section, types[]) → boolean`
  - `someSectionMatches(course, predicate) → boolean`
- Export:
  - `useCourseFilters(courses?: Ref<UICourse[]>)` → `{ filters, filteredCourses, applyFilters, reset }`
    - Inputs: optional ref of `UICourse[]`.
    - Outputs:
      - `filters`: reactive `CourseFiltersState`.
      - `filteredCourses`: computed `UICourse[]` after applying filters.
      - `applyFilters(list: UICourse[]) → UICourse[]` function.
      - `reset(): void` resets all filters.

#### `app/composables/useCourseListSource.ts`
- Types: `RouteMode` union for `all`, `scheduled`, `program`, `unknown`.
- Export: `useCourseListSource()` → `{ courses, reload, mode, scopeKey }`
  - Inputs: reads `useRoute()` and `useStore().scheduledCourses`.
  - Outputs:
    - `courses`: ref of `UICourse[]` bound to route mode.
    - `reload()`: fetches courses based on mode (all/scheduled/program).
    - `mode`: computed `RouteMode` from URL slug.
    - `scopeKey`: computed string to scope scroll memory.

#### `app/composables/useCourseSelection.ts`
- Export: `useCourseSelection()` → `{ selectedCourseCode, selectedSectionId, selectCourse, clearSelection }`
  - Inputs: none (reads/writes store refs).
  - Outputs: refs and functions to control current selection.

#### `app/composables/useSchedule.ts`
- Constants: `DAY_LABELS`, `START_MINUTES`, `END_MINUTES`, `SLOT_MINUTES`.
- Export: `useSchedule()` → schedule API
  - State outputs:
    - `blocks`: computed array of scheduled blocks + manual blocks.
    - `previewBlocks`: global ephemeral preview blocks.
    - `selectedCourseCode`, `selectedSectionId` (store passthrough).
  - CRUD functions:
    - `addBlock(input) → id`: Create manual block (normalized, snapped/clamped).
    - `updateBlock(id, patch)`: Update manual block with normalization.
    - `removeBlock(id)`, `clearBlocks()`, `setBlocks(next)`.
    - Preview: `setPreviewBlocks(next)`, `clearPreviewBlocks()`.
  - Helpers:
    - `geometryFor(block) → { topPct, heightPct, columnIndex }`.
    - `timeToMinutes(str)`, `minutesToTime(total)` passthroughs.
    - `parseBlocksFromString(spec, ...)`, `parseBlocksFromApiSpec(spec, ...)` passthroughs.
    - `hasCourseSection(code, sectionId) → boolean`
    - `removeCourseSection(code, sectionId)`: Proxy to store.
    - `setHoverPreviewFromString(spec, label?, code?)`, `clearHoverPreview()`.
  - Internal helpers: `clamp`, `roundToFiveMinutes`, `hashColorFromCourse`.

#### `app/composables/scheduleUtils.ts`
- Types: `DayOfWeek`, `ScheduleBlock`.
- Functions:
  - `timeToMinutes("HH:MM") → number`
  - `dayIndexFromToken(token) → number | null` (supports Sun/S/M/T/W/Th/F/Sat variants).
  - `parseBlocksFromString(spec, label?, color?, courseCode?) → ScheduleBlock[]` (e.g., "Mon/Wed 10:00 - 11:50").
  - `decodeApiDaysToken(token) → number[]` (e.g., `MWF`, `Th`).
  - `parseBlocksFromApiSpec(spec, label?, color?, courseCode?, sectionId?) → ScheduleBlock[]` (semi-colon chunks "MW 10:00 - 11:00; F 12:00 - 13:00").

#### `app/composables/useStore.ts`
- Export: `useStore()` → `{ usePersistentState, selectedCourseCode, selectedSectionId, scheduledCourses, upsertScheduledSection, hasScheduled, removeScheduledSection, totalScheduledUnits, totalScheduledUnitsLabel, checkScheduleCollision }`
  - `usePersistentState<T>(nuxtKey, storageKey, initialize)`
    - Inputs: keys + initializer.
    - Output: Nuxt state ref with localStorage hydration + persistence on client.
  - `selectedCourseCode`, `selectedSectionId`: persisted refs (`string|null`).
  - `scheduledCourses`: computed `UICourse[]` from internal map.
  - `upsertScheduledSection(course, section)`: Add/update a section for a course (by normalized code).
  - `hasScheduled(courseCode?, sectionId?) → boolean`.
  - `removeScheduledSection(courseCode?, sectionId?)`: Remove section or entire course if last section.
  - `totalScheduledUnits` (number) and `totalScheduledUnitsLabel` ("X.Y credits").
  - `checkScheduleCollision(spec: string) → string[]`: Returns colliding course codes for the input schedule spec.

#### `app/composables/useTimeParsing.ts`
- Functions:
  - `minutesToTime(total) → "HH:MM"`.
  - `parseTimeStrict("HH:MM") → minutes | null`.
  - `parseTimeLooseToMinutes(value) → minutes | null` (accepts `930`, `12:30`, etc.).

#### `app/composables/useVariableVirtualList.ts`
- Export: `useVariableVirtualList<T>({ items, estimateItemHeight?, getKey })`
  - Inputs: `items` ref, optional estimate, `getKey(item, index) → string`.
  - Outputs: `{ containerRef, startIndex, endIndex, topPadding, bottomPadding, visibleItems, onRowRef, updateViewport, scheduleUpdateViewport }`.
  - Internal helpers: `sumByIndex`, `findStartIndexForScroll`, `findEndIndexForViewport`.

#### `app/composables/useDraftInput.ts`
- Export: `useDraftInput<T>({ getValue, setValue, format, parse })`
  - Inputs: getter/setter, formatter, and parser returning `{ value, text, valid }`.
  - Outputs: `{ text, isEditing, draft, valid, onFocus, onInput, onBlur }`.

#### `app/composables/useScrollMemory.ts`
- Export: `useScrollMemory(scopeKey: () => string | string)`
  - Inputs: scope key (function or value).
  - Outputs: `{ containerRef, restore, persist }` that remembers/restores `scrollTop` per scope.

#### `app/composables/useCourseTypeMeta.ts`
- Types: `KnownCourseType = 'Lab' | 'Discussion'`, `CourseTypeMeta`.
- Export: `getCourseTypeMeta(type: string | null | undefined) → CourseTypeMeta | null`.

---

### Assets and data
#### `app/assets/data/programs.json`
- Shape: `{ schools: { name, prefix, programs: { name, prefix }[] }[], success: boolean }`.
- Used by: `useAPI.listSchoolAndPrograms()`.

#### `app/assets/data/courses.json`
- Shape: `{ [schoolPrefix]: { [programPrefix]: RawGroupedCourse[] } }` where each grouped course contains `title`, `description`, `courseCode`, and `sections` (with `sectionCode`, `instructors`, `units`, `total`, `registered`, `location`, `time`, `duplicatedCredits`, `prerequisites`, `dClearance`, `type`).
- Used by: `useAPI` mappers and queries (`listAllCourses`, `getSchoolCourses`, `getCourseDetails`, `getSectionDetails`).

---

### Styles
#### `app/assets/css/main.css`
- Tailwind entry point and custom design tokens (colors, surfaces) with `.dark`/`.light` overrides.
- Utility backgrounds: zebra/dotted variants.
- Helpers: `.hide-scrollbar-bg`, `.line-clamp-2`, `.text-sideways`.

---

### Configuration and scripts
#### `nuxt.config.ts`
- Enables Tailwind via Vite plugin, sets `srcDir: 'app'`, registers `@nuxt/eslint`, `@nuxt/ui`, `@nuxt/content`, global CSS, and head meta.
- Exposes `public.WORKERS_CI_COMMIT_SHA` for the footer.

#### `package.json`
- Scripts: `dev`, `build`, `generate`, `preview`, `postinstall` (`nuxt prepare`).
- Dependencies: Nuxt 4, Vue 3, Tailwind, ESLint, TypeScript, etc.

#### `eslint.config.mjs`
- Uses Nuxt’s ESLint preset via `withNuxt` and allows customizations.

#### `tsconfig.json`
- References Nuxt-generated tsconfigs under `.nuxt/`.

#### `scripts/generate-test-data.py`
- Purpose: Generate `programs.json` and `courses.json` from USC APIs.
- Key functions:
  - `process_course(course) → sections_output[]`: Normalizes a single course payload into section entries.
  - `get_courses(school_code, program_code) → grouped_courses[]`: Fetches program courses with retry logic; aggregates unique sections.
  - `fetch_program_courses(school_prefix, program_prefix)`: Wrapper for concurrent execution.
- Writes:
  - `../app/assets/data/programs.json`
  - `../app/assets/data/courses.json`

---

### Public
- `public/favicon.ico`, `public/robots.txt`: Static assets served at root.

---

### Notes on data flow
- Route drives `useCourseListSource.mode` which determines list source (all/scheduled/program).
- `MiddlePanel` renders filtered+virtualized course list; `CourseCard` emits section clicks.
- Selection is persisted (`useStore`), `RightPanel` loads details and shows schedule; schedule grid combines scheduled sections with manual blocks.

---

If anything becomes outdated, update this file alongside code edits to keep the map accurate.


